<template>
    <div class="row">
        <div class="col-md-12">
            <div id="content" class="content content-full-width">
                <!-- begin profile -->
                <div class="profile">
                    <div class="profile-header">
                        <!-- BEGIN profile-header-cover -->
                        <div class="profile-header-cover"></div>
                        <!-- END profile-header-cover -->
                        <!-- BEGIN profile-header-content -->
                        <div class="profile-header-content">
                            <!-- BEGIN profile-header-img -->
                            <div class="profile-header-img">
                                <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="">
                            </div>
                            <!-- END profile-header-img -->
                            <!-- BEGIN profile-header-info -->
                            <div class="profile-header-info">
                                <h4 class="m-t-10 m-b-5">{{ myUserLogged.pseudo }}</h4>
                                <p class="m-b-10" v-if="myUserLogged.role_id == 2"> Membre </p>
                                <p v-else > Administrateur </p>
                            </div>
                            <!-- END profile-header-info -->
                        </div>
                        <!-- END profile-header-content -->
                    </div>
                </div>
                <!-- end profile -->
                <!-- begin profile-content -->
                <div class="profile-content">
                    <!-- begin tab-content -->
                    <div class="tab-content p-0">
                        <!-- begin #profile-about tab -->
                        <div class="tab-pane fade in active show" id="profile-about">
                            <!-- begin table -->
                            <section id="register-form">
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="pr-1">
                                            <div class="card">
                                                <h5 class="card-header info-color white-text text-center py-4">
                                                    <strong>Modifier Utilisateur</strong>
                                                </h5>
                                                <div class="card-body px-lg-5 pt-0">
                                                    <form v-on:submit.prevent="updateUser" action='/' class="text-center" style="color: #757575;">
                                                        <!-- First name -->
                                                        <div class="md-form">
                                                            <label for="materialRegisterFormFirstName" class="active">Pseudo</label>
                                                            <input type="text" v-model="myUserToUpdate.pseudo" id="materialRegisterFormFirstName"
                                                                class="form-control">
                                                            <small id="materialRegisterFormPasswordHelpBlock"
                                                                class="form-text text-muted mb-4" v-if="this.errorPseudo"> {{ errorPseudo }}
                                                            </small>
                                                                <small id="materialRegisterFormPasswordHelpBlock"
                                                                class="form-text text-muted mb-4" v-if="this.pseudoNotAvailable"> {{ pseudoNotAvailable }}
                                                            </small>
                                                        </div>

                                                        <!-- E-mail -->
                                                        <div class="md-form">
                                                            <label for="materialRegisterFormEmail" class="active">E-mail</label>
                                                            <input type="email" v-model="myUserToUpdate.email" id="materialRegisterFormEmail" class="form-control">
                                                            <small id="materialRegisterFormPasswordHelpBlock"
                                                                class="form-text text-muted mb-4" v-if="this.errorEmail"> {{ errorEmail }} 
                                                            </small>                                    
                                                        </div>
                                                        <div class="submitUpdate">
                                                            <button class="btn btn-success" type="submit" >
                                                                Modifier
                                                            </button>
                                                            <button class="btn btn-primary" type="cancel" @click="cancelUpdate" >
                                                                Annuler
                                                            </button>
                                                        </div>
                                                        <hr>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- end table -->
                        </div>
                        <!-- end #profile-about tab -->
                    </div>
                    <!-- end tab-content -->
                </div>
                <!-- end profile-content -->
            </div>
        </div>
    </div>
</template>

<script>
import {mapGetters} from 'vuex';
import Axios from 'axios';
export default {
    name: 'UserProfileUpdate',
    data(){
        return {
            errorPseudo: null,
            errorEmail: null,
            pseudoNotAvailable: null,
            emailNotAvailable: null
        }
    },
    computed: {
        ...mapGetters({myUserLogged: "getCurrentUser"}),
        ...mapGetters({myUserToUpdate: "getUserToUpdate"}),
        name(){
            return this.myUserLogged.pseudo;
        },

        mail(){
            return this.myUserLogged.email;
        }
    },
    methods:{
        updateUser(){
            if(this.myUserLogged.role_id == 1){
                this.password = this.myUserLogged.password
            }
            if (!this.myUserToUpdate.pseudo){
                alert('Renseignez les champs');
            }
            else {
                Axios
                .post("http://localhost/annuairesante/backend/index.php", {
                    route: 'updateUser',
                    userLoggedPseudo: this.myUserLogged.pseudo,
                    id: this.myUserToUpdate.id,
                    pseudo: this.myUserToUpdate.pseudo,
                    email: this.myUserToUpdate.email
                })
                .then( response => {
                    if (response.data.errors){
                        // this.pseudoNotAvailable = response.data.errors.pseudoNotAvailable;
                        // this.emailNotAvailable = response.data.errors.emailNotAvailable;
                        this.errorPseudo = response.data.errors.pseudo;
                        this.errorEmail = response.data.errors.email;
                    }
                    else {
                        if(this.myUserLogged.role_id == 1){
                            this.$session.set('userUpdatedByAdmin', 'L\'utilisateur a été mis à jour');
                            this.$router.push({ path: '/AdminView' });
                        }
                        else {
                            this.$session.set('userUpdate', 'Vos informations ont été mises à jour.');
                            this.$router.push({ path: '/userprofile' });
                        }
                    }
                })  
                .catch(error => {
                    console.log(error)
                    this.errored = true
                })
            }
        },
        
        cancelUpdate(){
            this.$router.push({ path: '/userprofile' });
        }
    }
};
</script>

<style>
body{
    margin-top:20px;
    background:#eee;
}

.submitUpdate{
    display: flex;
    margin: 5%;
}

.profile-header {
    position: relative;
    overflow: hidden
}

.profile-header .profile-header-cover {
    background-color: #00b5ec;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0
}

.profile-header .profile-header-cover:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, .75) 100%)
}

.profile-header .profile-header-content {
    color: #fff;
    padding: 25px
}

.profile-header-img {
    float: left;
    width: 120px;
    height: 120px;
    overflow: hidden;
    position: relative;
    z-index: 10;
    margin: 0 0 -20px;
    padding: 3px;
    border-radius: 4px;
    background: #fff
}

.profile-header-img img {
    max-width: 100%
}

.profile-header-info h4 {
    font-weight: 500;
    color: #fff
}

.profile-header-img+.profile-header-info {
    margin-left: 140px
}

.profile-header .profile-header-content,
.profile-header .profile-header-tab {
    position: relative
}



.profile-header .profile-header-tab {
    background: #fff;
    list-style-type: none;
    margin: -10px 0 0;
    padding: 0 0 0 140px;
    white-space: nowrap;
    border-radius: 0
}

.text-ellipsis,
.text-nowrap {
    white-space: nowrap!important
}

.profile-header .profile-header-tab>li {
    display: inline-block;
    margin: 0
}

.profile-header .profile-header-tab>li>a {
    display: block;
    color: #929ba1;
    line-height: 20px;
    padding: 10px 20px;
    text-decoration: none;
    font-weight: 700;
    font-size: 12px;
    border: none
}

.profile-header .profile-header-tab>li.active>a,
.profile-header .profile-header-tab>li>a.active {
    color: #242a30
}

.profile-content {
    padding: 25px;
    border-radius: 4px
}

.profile-content:after,
.profile-content:before {
    content: '';
    display: table;
    clear: both
}

.profile-content .tab-content,
.profile-content .tab-pane {
    background: 0 0
}

.profile-left {
    width: 200px;
    float: left
}

.profile-right {
    margin-left: 240px;
    padding-right: 20px
}

.profile-image {
    height: 175px;
    line-height: 175px;
    text-align: center;
    font-size: 72px;
    margin-bottom: 10px;
    border: 2px solid #E2E7EB;
    overflow: hidden;
    border-radius: 4px
}

.profile-image img {
    display: block;
    max-width: 100%
}

.profile-highlight {
    padding: 12px 15px;
    background: #FEFDE1;
    border-radius: 4px
}

.profile-highlight h4 {
    margin: 0 0 7px;
    font-size: 12px;
    font-weight: 700
}

.table.table-profile>thead>tr>th {
    border-bottom: none!important
}

.table.table-profile>thead>tr>th h4 {
    font-size: 20px;
    margin-top: 0
}

.table.table-profile>thead>tr>th h4 small {
    display: block;
    font-size: 12px;
    font-weight: 400;
    margin-top: 5px
}

.table.table-profile>tbody>tr>td,
.table.table-profile>thead>tr>th {
    border: none;
    padding-top: 7px;
    padding-bottom: 7px;
    color: #242a30;
    background: 0 0
}

.table.table-profile>tbody>tr>td.field {
    width: 20%;
    text-align: right;
    font-weight: 600;
    color: #2d353c
}

.table.table-profile>tbody>tr.highlight>td {
    border-top: 1px solid #b9c3ca;
    border-bottom: 1px solid #b9c3ca
}

.table.table-profile>tbody>tr.divider>td {
    padding: 0!important;
    height: 10px
}

.profile-section+.profile-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #b9c3ca
}

.profile-section:after,
.profile-section:before {
    content: '';
    display: table;
    clear: both
}

.profile-section .title {
    font-size: 20px;
    margin: 0 0 15px
}

.profile-section .title small {
    font-weight: 400
}

body.flat-black {
    background: #E7E7E7
}

.flat-black .navbar.navbar-inverse {
    background: #212121
}

.flat-black .navbar.navbar-inverse .navbar-form .form-control {
    background: #4a4a4a;
    border-color: #4a4a4a
}

.flat-black .sidebar,
.flat-black .sidebar-bg {
    background: #3A3A3A
}

.flat-black .page-with-light-sidebar .sidebar,
.flat-black .page-with-light-sidebar .sidebar-bg {
    background: #fff
}

.flat-black .sidebar .nav>li>a {
    color: #b2b2b2
}

.flat-black .sidebar.sidebar-grid .nav>li>a {
    border-bottom: 1px solid #474747;
    border-top: 1px solid #474747
}

.flat-black .sidebar .active .sub-menu>li.active>a,
.flat-black .sidebar .nav>li.active>a,
.flat-black .sidebar .nav>li>a:focus,
.flat-black .sidebar .nav>li>a:hover,
.flat-black .sidebar .sub-menu>li>a:focus,
.flat-black .sidebar .sub-menu>li>a:hover,
.sidebar .nav>li.nav-profile>a {
    color: #fff
}

.flat-black .sidebar .sub-menu>li>a,
.flat-black .sidebar .sub-menu>li>a:before {
    color: #999
}

.flat-black .page-with-light-sidebar .sidebar .active .sub-menu>li.active>a,
.flat-black .page-with-light-sidebar .sidebar .active .sub-menu>li.active>a:focus,
.flat-black .page-with-light-sidebar .sidebar .active .sub-menu>li.active>a:hover,
.flat-black .page-with-light-sidebar .sidebar .nav>li.active>a,
.flat-black .page-with-light-sidebar .sidebar .nav>li.active>a:focus,
.flat-black .page-with-light-sidebar .sidebar .nav>li.active>a:hover {
    color: #000
}

.flat-black .page-sidebar-minified .sidebar .nav>li.has-sub:focus>a,
.flat-black .page-sidebar-minified .sidebar .nav>li.has-sub:hover>a {
    background: #323232
}

.flat-black .page-sidebar-minified .sidebar .nav li.has-sub>.sub-menu,
.flat-black .sidebar .nav>li.active>a,
.flat-black .sidebar .nav>li.active>a:focus,
.flat-black .sidebar .nav>li.active>a:hover,
.flat-black .sidebar .nav>li.nav-profile,
.flat-black .sidebar .sub-menu>li.has-sub>a:before,
.flat-black .sidebar .sub-menu>li:before,
.flat-black .sidebar .sub-menu>li>a:after {
    background: #2A2A2A
}

.flat-black .page-sidebar-minified .sidebar .sub-menu>li:before,
.flat-black .page-sidebar-minified .sidebar .sub-menu>li>a:after {
    background: #3e3e3e
}

.flat-black .sidebar .nav>li.nav-profile .cover.with-shadow:before {
    background: rgba(42, 42, 42, .75)
}

.bg-white {
    background-color: #fff!important;
}
.p-10 {
    padding: 10px!important;
}
.media.media-xs .media-object {
    width: 32px;
}
.m-b-2 {
    margin-bottom: 2px!important;
}
.media>.media-left, .media>.pull-left {
    padding-right: 15px;
}
.media-body, .media-left, .media-right {
    display: table-cell;
    vertical-align: top;
}
select.form-control:not([size]):not([multiple]) {
    height: 34px;
}
.form-control.input-inline {
    display: inline;
    padding: 0 7px;
}
                                    
</style>